- hosts: all
 
  tasks:
  - name: "Roda: sudo apt update"
    become: yes
    apt:
      upgrade: yes
      update_cache: yes
      cache_valid_time: 86400 #Um dia
    
  - name: "Instala pacotes em lote"
    apt:
      name: "{{ item }}"
      state: latest
    become: yes # roda com sudo
    with_items:
      - nginx
      - maven
      - mysql-server
      - unzip
      - python3-pycurl
      - python3-mysqldb
      

  - name: "Fazendo downlaod do template"
    get_url:
      url: "https://github.com/torneseumprogramador/spring-web-youtube/archive/refs/heads/main.zip"
      dest: "/tmp/spring_web.zip"

  - name: "Fazendo descompactação dos arquivos do WP"
    unarchive:
      src: "/tmp/spring_web.zip"
      dest: "/var/www"
      remote_src: yes
    become: yes

  - name: Roda maven package
    shell: "USER=root PASSWORD=root DATABASE_URL='mysql://localhost:3306/SpringWebYoutube?useTimezone=true&serverTimezone=UTC';cd /var/www/spring-web-youtube-main;sudo mvn package"
    become: yes

    # - name: Adicionar no bashrc
    #   lineinfile: dest=~/.bashrc line='export API_URL=https://localhost:5001' state=present

    # - name: Aplicar o bashrc
    #   shell: source ~/.bashrc
    #   args:
    #     executable: /bin/bash

  - name: "Lavanta serviço do mysql"
    become: yes
    service:
      name: mysql
      state: started

  - name: "Criando senha root mysql"
    become: yes
    mysql_user:
      name: root
      host: localhost
      password: root
      priv: "*.*:ALL,GRANT"
      state: present

  - name: "Cria o banco de dados MySQL"
    mysql_db:
      name: SpringWebYoutube
      login_user: root
      login_password: root
      state: present

  # - shell: cat /etc/apache2/sites-available/000-default.conf | grep 'wordpress'
  #   register:  ps
  # - debug:
  #     msg: " '{{ ps.stdout_lines}}' "